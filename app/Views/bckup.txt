<?=$this->include("layout/header") ?>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container"> 
        <?=$this->include("layout/sidebar") ?>
        <!-- Layout container -->
        <div class="layout-page">
          <?=$this->include("layout/navbar") ?>
          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->
            <div class="pt-4 ps-4">
                <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#formModal">
                    <i class="bx bx-plus me-1"></i> Tambah Data
                </button>
                
                <?php if(session()->getFlashdata('message')): ?>
                <div class="alert alert-success">
                    <?= session()->getFlashdata('message') ?>
                </div>
                <?php endif; ?>
            </div>
            <div class="container-xxl flex-grow-1 container-p-y">
                <div class="row">
                    <div class="card">
                        <div class="table-responsive text-nowrap p-3">
                            <table id="dataTableExample" class="display table table-striped" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Foto</th>
                                        <th>Nama</th>
                                        <th>Jabatan</th>
                                        <th>Divisi</th>
                                        <th>Atasan</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($nodes as $node): ?>
                                    <tr>
                                        <td><?= $node['id'] ?></td>
                                        <td>
                                            <?php if(!empty($node['photo'])): ?>
                                                <img src="<?= base_url('uploads/photos/' . $node['photo']) ?>" alt="Foto <?= $node['name'] ?>" width="50" class="rounded-circle">
                                            <?php else: ?>
                                                <img src="<?= base_url('assets/img/avatars/default.png') ?>" alt="Default" width="50" class="rounded-circle">
                                            <?php endif; ?>
                                        </td>
                                        <td><?= $node['name'] ?></td>
                                        <td><?= $node['position'] ?></td>
                                        <td><?= $node['id_divisi'] ?></td>
                                        <td>
                                            <?php 
                                            // Penanganan special case untuk parent_id = 0 atau null
                                            if (empty($node['parent_id']) || $node['parent_id'] == 0) {
                                                echo 'Tanpa Atasan';
                                            } else if (isset($nodes[$node['parent_id']])) {
                                                echo $nodes[$node['parent_id']]['name'];
                                            } else {
                                                echo 'Atasan Tidak Ditemukan';
                                            }
                                            ?>
                                        </td>
                                        <td>
                                            <a href="<?= base_url('edit/' . $node['id']) ?>" class="btn btn-sm btn-info">
                                                <i class="bx bx-edit"></i> Edit
                                            </a>
                                            <a href="<?= base_url('delete/' . $node['id']) ?>" class="btn btn-sm btn-danger" onclick="return confirm('Apakah Anda yakin ingin menghapus data ini?')">
                                                <i class="bx bx-trash"></i> Hapus
                                            </a>
                                        </td>
                                    </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
                <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                        <form action="<?= base_url('save') ?>" method="POST" enctype="multipart/form-data">
                            <div class="modal-header">
                            <h5 class="modal-title" id="formModalLabel">Form Input Data</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                            <div class="mb-3">
                                <label for="name" class="form-label">Nama:</label>
                                <input type="text" class="form-control" name="name" id="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="id_jabatan" class="form-label">Jabatan:</label>
                                <select class="form-select select2" name="id_jabatan" id="id_jabatan" required>
                                    <option value="">Pilih Jabatan</option>
                                    <?php foreach ($jabatan as $jabatan): ?>
                                        <option value="<?= $jabatan['id'] ?>"><?= $jabatan['nama_jabatan'] ?></option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="id_divisi" class="form-label">Divisi:</label>
                                <select class="form-select select2" name="id_divisi" id="id_divisi">
                                    <option value="">Pilih Divisi</option>
                                    <?php foreach ($divisi as $divisi): ?>
                                        <option value="<?= $divisi['id'] ?>"><?= $divisi['nama_divisi'] ?></option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="parent_id" class="form-label">Atasan:</label>
                                <select class="form-select select2" name="parent_id" id="parent_id">
                                    <option value="">Tanpa Atasan</option>
                                    <?php foreach ($nodes as $node): ?>
                                        <option value="<?= $node['id'] ?>"><?= $node['name'] ?></option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="photo" class="form-label">Foto:</label>
                                <input type="file" class="form-control" name="photo" id="photo" accept="image/*">
                                <small class="text-muted">Upload foto dengan format JPG, PNG, atau GIF. Max size 2MB.</small>
                            </div>
                            </div>
                            <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-primary">Simpan</button>
                            </div>
                        </form>
                        </div>
                    </div>
                </div>

            <!-- / Content -->
            <!-- Footer -->
        
<?=$this->include("layout/footer") ?>